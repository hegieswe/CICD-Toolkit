#!/usr/bin/env python3

import sys
import os
import shutil
import subprocess
import argparse
import time
import threading
from pathlib import Path

# =========================
# Configuration & Constants
# =========================
DEFAULT_WORKSPACE = "loyaltoid"
DEFAULT_GIT_HOST = "bitbucket.org"

class Style:
    CYAN = "\033[36m"
    BOLD = "\033[1m"
    DIM = "\033[2m"
    RED = "\033[31m"
    YELLOW = "\033[33m"
    RESET = "\033[0m"

class Icon:
    WARN = "‚ö†Ô∏è "
    SUCCESS = "‚úÖ "
    ERROR = "‚ùå "
    REPO = "üì¶ "
    LINK = "üîó "
    BRANCH = "üåø "
    MODE = "üß¨ "

# Box Drawing Characters (Rounded)
class Box:
    TL = "‚ï≠" # Top Left
    TR = "‚ïÆ" # Top Right
    BL = "‚ï∞" # Bottom Left
    BR = "‚ïØ" # Bottom Right
    H  = "‚îÄ" # Horizontal

# =========================
# Visual Helpers
# =========================
def print_header(repo_name, repo_url, ref, is_single):
    mode_str = "Single Branch" if is_single else "Full Clone"
    
    # Dynamic Width Calculation
    # Content format: " {ICON} {LABEL} : {VALUE}"
    # Prefix length (approx): Space(1) + Icon(2) + Space(1) + Label(~10) + Space(1) + Colon(1) + Space(1) = ~17-18 chars
    # We'll calculate conservatively.
    
    # Approx lengths including padding/icons
    # " üì¶ Repository : " is 16 chars
    PREFIX_LEN = 16 
    PADDING = 6 # Extra buffer for aesthetics (longer than content)

    content_lens = [
        len(repo_name),
        len(repo_url),
        len(mode_str)
    ]
    if ref:
        content_lens.append(len(ref))
        
    box_width = PREFIX_LEN + max(content_lens) + PADDING
    
    # Ensure a minimum width so it doesn't look too narrow
    box_width = max(box_width, 50)

    title = "Repo Info"
    remaining = box_width - len(title) - 3  # -3 for "‚îÄ " before and " " after title
    print(f"{Style.DIM}{Box.TL}{Box.H} {Style.RESET}{Style.BOLD}{title}{Style.RESET}{Style.DIM} {Box.H * remaining}{Box.TR}{Style.RESET}")
    print(f" {Icon.REPO} Repository : {repo_name}")
    print(f" {Icon.LINK} Source     : {repo_url}")
    if ref:
        print(f" {Icon.BRANCH} Ref        : {ref}")
    
    print(f" {Icon.MODE} Mode       : {mode_str}")

    print(f"{Style.DIM}{Box.BL}{Box.H * box_width}{Box.BR}{Style.RESET}")

class Spinner:
    """A simple spinner that clears itself when stopped."""
    def __init__(self, message="Processing..."):
        self.message = message
        self.busy = False
        self.delay = 0.1
        self._thread = None
        self.frames = ["‚†ã", "‚†ô", "‚†π", "‚†∏", "‚†º", "‚†¥", "‚†¶", "‚†ß", "‚†á", "‚†è"]

    def write(self, text):
        sys.stdout.write(text)
        sys.stdout.flush()

    def _spin(self):
        i = 0
        while self.busy:
            self.write(f"\r{Style.CYAN}{self.frames[i % len(self.frames)]}{Style.RESET} {self.message}")
            time.sleep(self.delay)
            i += 1

    def start(self):
        self.busy = True
        self._thread = threading.Thread(target=self._spin)
        self._thread.start()

    def stop(self, success=True):
        self.busy = False
        if self._thread:
            self._thread.join()
        # Clear the line
        sys.stdout.write(f"\r{' ' * (len(self.message) + 10)}\r")
        sys.stdout.flush()

def warn(msg):
    print(f"{Style.YELLOW}{Icon.WARN}{Style.BOLD}{msg}{Style.RESET}")

def error(msg):
    print(f"{Style.RED}{Icon.ERROR} {Style.BOLD}{msg}{Style.RESET}")

def fatal(msg, code=1):
    error(msg)
    sys.exit(code)

# =========================
# Git Operations
# =========================
def check_requirements(host):
    """Check if git is available."""
    try:
        subprocess.run(["git", "--version"], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL, check=True)
    except FileNotFoundError:
        fatal("Git not found. Please install git.")

def get_repo_url(host, workspace, repo):
    return f"git@{host}:{workspace}/{repo}.git"

def main():
    parser = argparse.ArgumentParser(
        description=f"{Style.BOLD}Clone repository from {DEFAULT_GIT_HOST} (or configured host){Style.RESET}",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    
    parser.add_argument("repo", help="Repository name")
    parser.add_argument("ref", nargs="?", help="Branch or Tag to checkout (optional)")
    parser.add_argument("-s", "--single", action="store_true", help="Single branch clone (shallow if possible)")
    parser.add_argument("-d", "--depth", type=int, help="Create a shallow clone with a history truncated to the specified number of commits")
    parser.add_argument("-w", "--workspace", help="Override workspace (default: env CL_WORKSPACE or 'loyaltoid')", default=os.environ.get("CL_WORKSPACE", DEFAULT_WORKSPACE))
    parser.add_argument("--host", help="Override git host (default: env CL_GIT_HOST or 'bitbucket.org')", default=os.environ.get("CL_GIT_HOST", DEFAULT_GIT_HOST))

    args = parser.parse_args()

    # Setup
    repo_name = args.repo
    ref = args.ref
    repo_dir = Path(repo_name)
    repo_url = get_repo_url(args.host, args.workspace, repo_name)

    print_header(repo_name, repo_url, ref, args.single)
    
    # Pre-flight
    check_requirements(args.host)
    replaced = False

    # Cleanup existing
    if repo_dir.exists():
        spinner = Spinner(f"Removing existing '{repo_name}'...")
        spinner.start()
        try:
            shutil.rmtree(repo_dir)
            spinner.stop(success=True)
            replaced = True
        except Exception as e:
            spinner.stop(success=False)
            fatal(f"Failed to remove directory: {e}")

    # Operations
    start_time = time.time()
    
    git_cmd = ["git", "clone"]
    
    if args.single:
        git_cmd.append("--single-branch")

    if args.depth:
        git_cmd.extend(["--depth", str(args.depth)])

    if ref and args.single:
         git_cmd.extend(["--branch", ref])
    
    git_cmd.append(repo_url)

    spinner_clone = Spinner(f"Cloning {repo_name}...")
    spinner_clone.start()
    
    try:
        proc = subprocess.run(
            git_cmd,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            encoding='utf-8'
        )
        
        if proc.returncode != 0:
            spinner_clone.stop(success=False)
            print(proc.stderr)
            fatal("Git clone failed.")
        else:
            spinner_clone.stop(success=True)

        if ref and not args.single:
            spinner_checkout = Spinner(f"Checking out {ref}...")
            spinner_checkout.start()
            
            subprocess.run(
                ["git", "checkout", ref],
                cwd=repo_dir,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                check=True
            )
            spinner_checkout.stop(success=True)
            
    except subprocess.CalledProcessError as e:
        spinner_clone.stop(success=False)
        fatal(f"Git Error: {e}")
    except KeyboardInterrupt:
        print()
        fatal("Cancelled.", 0)

    elapsed = time.time() - start_time
    
    # Output results
    if replaced:
        print(f"{Icon.WARN}  Replaced existing directory")
    
    print(f"{Icon.SUCCESS} Cloned successfully in {elapsed:.2f}s")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print()
        sys.exit(0)
