#!/usr/bin/env python3

import sys
import shutil
import subprocess
from pathlib import Path

# =========================
# Config
# =========================
WORKSPACE = "loyaltoid"
GIT_HOST = "bitbucket.org"

# =========================
# Colors
# =========================
YELLOW = "\033[33m"
GREEN = "\033[32m"
RED = "\033[31m"
BOLD = "\033[1m"
RESET = "\033[0m"

# =========================
# Icons
# =========================
INFO_ICON = "‚ÑπÔ∏è "
WARN_ICON = "‚ö†Ô∏è "
SUCCESS_ICON = "‚úÖ "
ERROR_ICON = "‚ùå "
REPO_ICON = "üì¶ "

# =========================
# Logging helpers
# =========================
def info(msg):
    print(f"{YELLOW}{INFO_ICON}{BOLD}{msg}{RESET}")

def repo(msg):
    print(f"{YELLOW}{REPO_ICON}{BOLD}{msg}{RESET}")

def warn(msg):
    print(f"{RED}{WARN_ICON}{BOLD}{msg}{RESET}")

def success(msg):
    print(f"{GREEN}{SUCCESS_ICON}{BOLD}{msg}{RESET}")

def error(msg):
    print(f"{RED}{ERROR_ICON}{BOLD}{msg}{RESET}")

def fatal(msg, code=1):
    error(msg)
    sys.exit(code)

# =========================
# Usage
# =========================
def usage():
    error("Invalid usage")
    print("Usage:")
    print("  cl <repo> <branch|tag>")
    print("  cl <repo> <branch|tag> sl   # single branch clone")
    sys.exit(1)

# =========================
# Argument parsing
# =========================
args = sys.argv[1:]

if len(args) < 2 or len(args) > 3:
    usage()

REPO_NAME = args[0]
REF = args[1]
MODE = args[2] if len(args) == 3 else ""

REPO_DIR = Path(REPO_NAME)

# üîë SSH URL (INI KUNCI UTAMANYA)
REPO_URL = f"git@{GIT_HOST}:{WORKSPACE}/{REPO_NAME}.git"

# =========================
# Pre-flight checks
# =========================
def check_git():
    try:
        subprocess.run(
            ["git", "--version"],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
            check=True
        )
    except Exception:
        fatal("Git tidak ditemukan. Install git terlebih dahulu.")

def check_ssh():
    try:
        subprocess.run(
            ["ssh", "-T", f"git@{GIT_HOST}"],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )
    except Exception:
        fatal("SSH tidak tersedia atau ssh-key belum terpasang.")

check_git()
check_ssh()

# =========================
# Cleanup existing repo
# =========================
if REPO_DIR.exists():
    warn(f"Directory '{REPO_NAME}' sudah ada. Menghapus...")
    try:
        shutil.rmtree(REPO_DIR)
    except Exception as e:
        fatal(f"Gagal menghapus directory '{REPO_NAME}': {e}")

# =========================
# Info summary
# =========================
repo(f"Repository : {REPO_NAME}")
info(f"Ref        : {REF}")

if MODE == "sl":
    info("Mode       : Single branch clone")
else:
    info("Mode       : Full clone")

# =========================
# Clone logic
# =========================
try:
    if MODE == "sl":
        subprocess.run(
            [
                "git", "clone",
                "--branch", REF,
                "--single-branch",
                REPO_URL
            ],
            check=True
        )
    else:
        subprocess.run(
            ["git", "clone", REPO_URL],
            check=True
        )
        subprocess.run(
            ["git", "checkout", REF],
            cwd=REPO_DIR,
            check=True
        )
except subprocess.CalledProcessError:
    fatal("Git command gagal dijalankan. Periksa nama repo atau branch/tag.")

# =========================
# Done
# =========================
success(f"Clone selesai: {REPO_NAME}")
