#!/usr/bin/env python3
"""
cl - Fast Git Clone Tool
Multi-account repository cloning with SSH key profiles.

Usage:
    cl repo                       # Interactive profile selection
    cl repo -p kantor              # Clone from Bitbucket (loyaltoid)
    cl repo -p pribadi             # Clone from GitHub (hegieswe)
    cl repo -p project             # Clone from GitHub (TrueChainID)
    cl repo branch -p kantor -s    # Fast single-branch clone
"""

import sys
import os
import shutil
import subprocess
import time
import threading
import re
from pathlib import Path

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
VERSION = "4.0.0"

# SSH key directory
SSH_DIR = Path.home() / ".ssh"

# Account profiles: name -> (ssh_key_file, git_host, workspace, label)
PROFILES = {
    "kantor": {
        "ssh_key": "id_ed25519_bitbucket_kantor",
        "host": "bitbucket.org",
        "workspace": "loyaltoid",
        "label": "Bitbucket Kantor",
        "icon": "ğŸ¢",
    },
    "pribadi": {
        "ssh_key": "id_ed25519_github_pribadi",
        "host": "github.com",
        "workspace": "hegieswe",
        "label": "GitHub Pribadi",
        "icon": "ğŸ‘¤",
    },
    "project": {
        "ssh_key": "id_ed25519_github_project",
        "host": "github.com",
        "workspace": "TrueChainID",
        "label": "GitHub Project",
        "icon": "ğŸš€",
    },
}

DEFAULT_PROFILE = "kantor"
CONFIG_DIR = Path.home() / ".config" / "cl"
CONFIG_FILE = CONFIG_DIR / "profile"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STYLING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Style:
    CYAN    = "\033[96m"
    GREEN   = "\033[92m"
    YELLOW  = "\033[93m"
    RED     = "\033[91m"
    MAGENTA = "\033[95m"
    BLUE    = "\033[94m"
    BOLD    = "\033[1m"
    DIM     = "\033[2m"
    RESET   = "\033[0m"

class Icon:
    SUCCESS  = "âœ”"
    ERROR    = "âœ–"
    WARN     = "âš "
    REPO     = "ğŸ“¦"
    LINK     = "ğŸ”—"
    BRANCH   = "ğŸŒ¿"
    MODE     = "âš¡"
    ROCKET   = "ğŸš€"
    CLOCK    = "â± "
    SIZE     = "ğŸ’¾"
    SPEED    = "ğŸš€"
    RECYCLE  = "â™»ï¸ "

class Box:
    TL = "â•­"
    TR = "â•®"
    BL = "â•°"
    BR = "â•¯"
    H  = "â”€"
    V  = "â”‚"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SPINNER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Spinner:
    FRAMES = ["â ‹", "â ™", "â ¹", "â ¸", "â ¼", "â ´", "â ¦", "â §", "â ‡", "â "]
    
    def __init__(self, message="Processing..."):
        self.message = message
        self.busy = False
        self.delay = 0.08
        self._thread = None
        self._progress = ""
        self._lock = threading.Lock()
    
    def update_progress(self, progress):
        with self._lock:
            self._progress = progress
    
    def _spin(self):
        i = 0
        while self.busy:
            with self._lock:
                progress = self._progress
            line = f"\r{Style.CYAN}{self.FRAMES[i % 10]}{Style.RESET} {self.message}"
            if progress:
                line += f" {Style.DIM}{progress}{Style.RESET}"
            sys.stdout.write(f"{line:<80}")
            sys.stdout.flush()
            time.sleep(self.delay)
            i += 1
    
    def start(self):
        self.busy = True
        self._thread = threading.Thread(target=self._spin, daemon=True)
        self._thread.start()
    
    def stop(self, success=True, message=None):
        self.busy = False
        if self._thread:
            self._thread.join(timeout=0.2)
        icon = f"{Style.GREEN}{Icon.SUCCESS}" if success else f"{Style.RED}{Icon.ERROR}"
        sys.stdout.write(f"\r{icon}{Style.RESET} {message or self.message:<75}\n")
        sys.stdout.flush()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UTILITIES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def format_size(b):
    for u in ['B', 'KB', 'MB', 'GB']:
        if b < 1024:
            return f"{b:.1f} {u}"
        b /= 1024
    return f"{b:.1f} TB"

def format_time(s):
    if s < 1:
        return f"{s * 1000:.0f}ms"
    elif s < 60:
        return f"{s:.1f}s"
    return f"{int(s // 60)}m {s % 60:.0f}s"

def get_size(path):
    total = 0
    try:
        for e in os.scandir(path):
            if e.is_file(follow_symlinks=False):
                total += e.stat().st_size
            elif e.is_dir(follow_symlinks=False):
                total += get_size(e.path)
    except (PermissionError, OSError):
        pass
    return total

def fatal(msg):
    print(f"  {Style.RED}{Icon.ERROR}{Style.RESET} {Style.BOLD}{msg}{Style.RESET}")
    sys.exit(1)

def get_default_profile():
    """Read saved default profile from config file."""
    try:
        if CONFIG_FILE.exists():
            saved = CONFIG_FILE.read_text().strip()
            if saved in PROFILES:
                return saved
    except (OSError, IOError):
        pass
    return DEFAULT_PROFILE

def save_default_profile(profile_name):
    """Save default profile to config file."""
    try:
        CONFIG_DIR.mkdir(parents=True, exist_ok=True)
        CONFIG_FILE.write_text(profile_name)
        return True
    except (OSError, IOError) as e:
        print(f"  {Style.RED}{Icon.ERROR}{Style.RESET} Failed to save config: {e}")
        return False

def print_profiles():
    """Display all available profiles with status."""
    current_default = get_default_profile()
    
    print()
    print(f"  {Style.CYAN}{Style.BOLD}ğŸ“‹ Available Profiles{Style.RESET}  {Style.DIM}(v{VERSION}){Style.RESET}")
    print(f"  {Style.DIM}{'â”' * 60}{Style.RESET}")
    
    for key, p in PROFILES.items():
        ssh_key_path = SSH_DIR / p["ssh_key"]
        ssh_exists = ssh_key_path.exists()
        ssh_status = f"{Style.GREEN}{Icon.SUCCESS} Ready" if ssh_exists else f"{Style.RED}{Icon.ERROR} Missing"
        
        is_default = key == current_default
        marker = f"{Style.GREEN}â–¸" if is_default else " "
        default_tag = f" {Style.GREEN}{Style.BOLD}[DEFAULT]{Style.RESET}" if is_default else ""
        
        print(f"  {marker} {p['icon']}  {Style.BOLD}{key}{Style.RESET}{default_tag}")
        print(f"      {Style.DIM}Label     :{Style.RESET} {p['label']}")
        print(f"      {Style.DIM}Host      :{Style.RESET} {p['host']}")
        print(f"      {Style.DIM}Workspace :{Style.RESET} {p['workspace']}")
        print(f"      {Style.DIM}SSH Key   :{Style.RESET} {p['ssh_key']}  {ssh_status}{Style.RESET}")
        print(f"      {Style.DIM}Key Path  :{Style.RESET} {Style.DIM}{ssh_key_path}{Style.RESET}")
        print()
    
    print(f"  {Style.DIM}{'â”' * 60}{Style.RESET}")
    print(f"  {Style.DIM}Default profile: {Style.RESET}{Style.BOLD}{current_default}{Style.RESET}")
    print(f"  {Style.DIM}Change default : {Style.RESET}{Style.DIM}cl --set-default <profile>{Style.RESET}")
    print()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GIT OPERATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def clone_with_progress(cmd, spinner, env=None):
    proc = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True, env=env)
    output = []
    for line in iter(proc.stderr.readline, ''):
        output.append(line)
        if "Receiving objects:" in line:
            m = re.search(r'(\d+)%', line)
            if m:
                spinner.update_progress(f"Receiving: {m.group(1)}%")
        elif "Resolving deltas:" in line:
            m = re.search(r'(\d+)%', line)
            if m:
                spinner.update_progress(f"Resolving: {m.group(1)}%")
        elif "Cloning into" in line:
            spinner.update_progress("Connecting...")
    proc.wait()
    return proc.returncode, ''.join(output)

def select_profile_interactive():
    """Interactive profile selection menu."""
    print()
    print(f"  {Style.CYAN}{Style.BOLD}Select Account Profile:{Style.RESET}")
    print(f"  {Style.DIM}{'â”€' * 45}{Style.RESET}")
    
    profile_keys = list(PROFILES.keys())
    for idx, key in enumerate(profile_keys, 1):
        p = PROFILES[key]
        ssh_status = f"{Style.GREEN}{Icon.SUCCESS}" if (SSH_DIR / p["ssh_key"]).exists() else f"{Style.RED}{Icon.ERROR}"
        print(f"  {Style.BOLD}{idx}{Style.RESET}) {p['icon']}  {p['label']:<20} {Style.DIM}({p['host']}/{p['workspace']}){Style.RESET}  {ssh_status}{Style.RESET}")
    
    print(f"  {Style.DIM}{'â”€' * 45}{Style.RESET}")
    print()
    
    while True:
        try:
            choice = input(f"  {Style.CYAN}â–¸{Style.RESET} Choose [1-{len(profile_keys)}]: ").strip()
            if choice.isdigit() and 1 <= int(choice) <= len(profile_keys):
                selected = profile_keys[int(choice) - 1]
                print(f"  {Style.GREEN}{Icon.SUCCESS}{Style.RESET} Using profile: {Style.BOLD}{PROFILES[selected]['label']}{Style.RESET}")
                return selected
            print(f"  {Style.RED}{Icon.ERROR} Invalid choice, try again.{Style.RESET}")
        except (EOFError, KeyboardInterrupt):
            print()
            sys.exit(130)

def get_ssh_env(profile):
    """Build environment with GIT_SSH_COMMAND for the profile's SSH key."""
    p = PROFILES[profile]
    ssh_key_path = SSH_DIR / p["ssh_key"]
    
    if not ssh_key_path.exists():
        fatal(f"SSH key not found: {ssh_key_path}")
    
    env = os.environ.copy()
    env["GIT_SSH_COMMAND"] = f"ssh -i {ssh_key_path} -o IdentitiesOnly=yes"
    return env

def run_clone(repo, ref, single_branch, profile):
    p = PROFILES[profile]
    workspace = p["workspace"]
    host = p["host"]
    ssh_key = p["ssh_key"]
    
    repo_dir = Path(repo)
    repo_url = f"git@{host}:{workspace}/{repo}.git"
    replaced = False
    
    # Get SSH env
    env = get_ssh_env(profile)
    
    # Mode
    mode_plain = "Single Branch (depth: 1)" if single_branch else "Full Clone"
    
    # Build info lines for dynamic box width
    info_lines = [
        f"{Icon.REPO} Repository:  {repo}",
        f"{Icon.LINK} Source:      {repo_url}",
        f"   Profile:     {p['label']} ({profile})",
        f"   SSH Key:     {ssh_key}",
    ]
    if ref:
        info_lines.append(f"{Icon.BRANCH} Ref:         {ref}")
    info_lines.append(f"{Icon.MODE} Mode:        {mode_plain}")
    
    # Calculate box width
    max_len = max(len(line) for line in info_lines)
    box_width = max_len + 4
    box_width = max(box_width, 50)
    
    # Print header box
    title = "Repository Information"
    title_line = f"{Box.TL}{Box.H}{title}{Box.H * (box_width - len(title) - 1)}{Box.TR}"
    
    print()
    print(f"{Style.GREEN}{title_line}{Style.RESET}")
    print(f"{Style.GREEN}{Box.V}{Style.RESET}{Icon.REPO}  {Style.RED}Repository :{Style.RESET} {Style.GREEN}{repo}{Style.RESET}")
    print(f"{Style.GREEN}{Box.V}{Style.RESET}{Icon.LINK}  {Style.RED}Source     :{Style.RESET} {Style.GREEN}{repo_url}{Style.RESET}")
    print(f"{Style.GREEN}{Box.V}{Style.RESET}{p['icon']}  {Style.RED}Profile    :{Style.RESET} {Style.GREEN}{p['label']}{Style.RESET} {Style.DIM}({profile}){Style.RESET}")
    print(f"{Style.GREEN}{Box.V}{Style.RESET}ğŸ”‘  {Style.RED}SSH Key    :{Style.RESET} {Style.CYAN}{ssh_key}{Style.RESET}")
    if ref:
        print(f"{Style.GREEN}{Box.V}{Style.RESET}{Icon.BRANCH}  {Style.RED}Ref        :{Style.RESET} {Style.GREEN}{ref}{Style.RESET}")
    print(f"{Style.GREEN}{Box.V}{Style.RESET}{Icon.MODE}  {Style.RED}Mode       :{Style.RESET} {Style.GREEN}{mode_plain}{Style.RESET}")
    print(f"{Style.GREEN}{Box.BL}{Box.H * box_width}{Box.BR}{Style.RESET}")
    print()
    
    # Remove existing (auto-overwrite)
    if repo_dir.exists():
        spinner = Spinner(f"Removing existing '{repo}'...")
        spinner.start()
        try:
            shutil.rmtree(repo_dir)
            spinner.stop(success=True, message=f"Removed existing '{repo}'")
            replaced = True
        except Exception as e:
            spinner.stop(success=False)
            fatal(f"Failed to remove: {e}")
    
    # Build command
    cmd = ["git", "clone", "--progress"]
    if single_branch:
        cmd.extend(["--single-branch", "--depth", "1"])
        if ref:
            cmd.extend(["--branch", ref])
    cmd.extend([repo_url, str(repo_dir)])
    
    # Clone
    start = time.perf_counter()
    spinner = Spinner(f"Cloning {repo}...")
    spinner.start()
    
    try:
        code, stderr = clone_with_progress(cmd, spinner, env=env)
        if code != 0:
            spinner.stop(success=False, message="Clone failed")
            if stderr:
                print(f"\n{Style.DIM}{stderr}{Style.RESET}")
            fatal("Git clone failed.")
        spinner.stop(success=True, message=f"Cloned {repo}")
    except KeyboardInterrupt:
        spinner.stop(success=False, message="Cancelled")
        if repo_dir.exists():
            shutil.rmtree(repo_dir, ignore_errors=True)
        sys.exit(130)
    
    # Persist SSH key in repo config (so push/pull/fetch use correct key)
    ssh_key_path = SSH_DIR / ssh_key
    ssh_cmd = f"ssh -i {ssh_key_path} -o IdentitiesOnly=yes"
    result = subprocess.run(
        ["git", "config", "core.sshCommand", ssh_cmd],
        cwd=repo_dir, capture_output=True, text=True
    )
    if result.returncode == 0:
        print(f"  {Style.GREEN}{Icon.SUCCESS}{Style.RESET} SSH key configured for push/pull/fetch")
    else:
        print(f"  {Style.YELLOW}{Icon.WARN}{Style.RESET} Could not set SSH config: {result.stderr.strip()}")
    
    # Checkout (full clone only)
    if ref and not single_branch:
        spinner = Spinner(f"Checking out {ref}...")
        spinner.start()
        result = subprocess.run(["git", "checkout", ref], cwd=repo_dir, capture_output=True, text=True, env=env)
        if result.returncode == 0:
            spinner.stop(success=True, message=f"Checked out {ref}")
        else:
            spinner.stop(success=False, message=f"Failed to checkout {ref}")
            if result.stderr:
                print(f"  {Style.DIM}{result.stderr.strip()}{Style.RESET}")
    
    # Summary
    elapsed = time.perf_counter() - start
    size = get_size(repo_dir)
    
    print()
    print(f"  {Icon.CLOCK}  Duration  : {Style.GREEN}{format_time(elapsed)}{Style.RESET}")
    print(f"  {Icon.SIZE}  Size      : {Style.CYAN}{format_size(size)}{Style.RESET}")
    print(f"  {Icon.SPEED}  Speed     : {Style.CYAN}{format_size(size / elapsed)}/s{Style.RESET}")
    if replaced:
        print(f"  {Icon.RECYCLE}  Replaced  : {Style.YELLOW}Yes{Style.RESET}")
    print()
    print(f"  {Style.GREEN}{Icon.SUCCESS} Ready{Style.RESET} â†’ {Style.DIM}cd {repo}{Style.RESET}")
    print()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def print_usage():
    profiles_str = ", ".join(PROFILES.keys())
    print(f"""
{Style.CYAN}{Style.BOLD}cl{Style.RESET} - Fast Git Clone Tool {Style.DIM}v{VERSION}{Style.RESET}

{Style.BOLD}Usage:{Style.RESET}
    cl <repo>                          Interactive profile selection
    cl <repo> -p <profile>             Clone with specified profile
    cl <repo> <branch/tag> -p <profile> -s   Fast single-branch clone

{Style.BOLD}Profiles:{Style.RESET}""")
    for key, p in PROFILES.items():
        ssh_exists = (SSH_DIR / p["ssh_key"]).exists()
        status = f"{Style.GREEN}{Icon.SUCCESS}" if ssh_exists else f"{Style.RED}{Icon.ERROR}"
        print(f"    {p['icon']}  {Style.BOLD}{key:<10}{Style.RESET} {p['label']:<22} {Style.DIM}({p['host']}/{p['workspace']}){Style.RESET} {status}{Style.RESET}")
    print(f"""
{Style.BOLD}Options:{Style.RESET}
    -p, --profile    Account profile ({profiles_str})
    -s, --single     Single-branch mode (faster clone)
    -l, --list       List all profiles with status
    --set-default    Set default profile
    -w, --workspace  Override workspace from profile
    --host           Override git host from profile
    -h, --help       Show this help
    -v, --version    Show version

{Style.BOLD}Examples:{Style.RESET}
    cl myrepo -p kantor               Clone from Bitbucket (loyaltoid)
    cl myrepo -p pribadi              Clone from GitHub (hegieswe)
    cl myrepo -p project              Clone from GitHub (TrueChainID)
    cl myrepo main -p kantor -s       Fast clone branch 'main'
    cl myrepo                         Interactive profile selection
    cl -l                             List all profiles
    cl --set-default pribadi          Set default profile to pribadi

{Style.BOLD}Note:{Style.RESET}
    If directory exists, it will be {Style.YELLOW}automatically replaced{Style.RESET}.
    SSH keys are loaded from {Style.DIM}~/.ssh/{Style.RESET} based on profile.
""")

def main():
    args = sys.argv[1:]
    
    # Defaults
    profile = None
    workspace_override = None
    host_override = None
    single_branch = False
    repo = None
    ref = None
    
    # Parse args manually for simplicity
    positional = []
    i = 0
    while i < len(args):
        arg = args[i]
        if arg in ["-h", "--help"]:
            print_usage()
            sys.exit(0)
        elif arg in ["-v", "--version"]:
            print(f"cl {VERSION}")
            sys.exit(0)
        elif arg in ["-l", "--list"]:
            print_profiles()
            sys.exit(0)
        elif arg == "--set-default" and i + 1 < len(args):
            i += 1
            new_default = args[i].lower()
            if new_default not in PROFILES:
                print(f"{Style.RED}{Icon.ERROR} Unknown profile '{new_default}'. Available: {', '.join(PROFILES.keys())}{Style.RESET}")
                sys.exit(1)
            if save_default_profile(new_default):
                p = PROFILES[new_default]
                print(f"  {Style.GREEN}{Icon.SUCCESS}{Style.RESET} Default profile set to: {p['icon']}  {Style.BOLD}{p['label']}{Style.RESET} {Style.DIM}({new_default}){Style.RESET}")
            sys.exit(0)
        elif arg in ["-s", "--single"]:
            single_branch = True
        elif arg in ["-p", "--profile"] and i + 1 < len(args):
            i += 1
            profile = args[i].lower()
            if profile not in PROFILES:
                print(f"{Style.RED}{Icon.ERROR} Unknown profile '{profile}'. Available: {', '.join(PROFILES.keys())}{Style.RESET}")
                sys.exit(1)
        elif arg in ["-w", "--workspace"] and i + 1 < len(args):
            i += 1
            workspace_override = args[i]
        elif arg == "--host" and i + 1 < len(args):
            i += 1
            host_override = args[i]
        elif not arg.startswith("-"):
            positional.append(arg)
        else:
            print(f"{Style.RED}Unknown option: {arg}{Style.RESET}")
            sys.exit(1)
        i += 1
    
    if len(positional) < 1:
        print_usage()
        sys.exit(1)
    
    repo = positional[0]
    ref = positional[1] if len(positional) > 1 else None
    
    # Profile selection
    if profile is None:
        profile = select_profile_interactive()
    
    # Apply overrides if provided
    if workspace_override:
        PROFILES[profile]["workspace"] = workspace_override
    if host_override:
        PROFILES[profile]["host"] = host_override
    
    # Check git
    try:
        subprocess.run(["git", "--version"], capture_output=True, timeout=5, check=True)
    except Exception:
        fatal("Git not found. Please install git.")
    
    run_clone(repo, ref, single_branch, profile)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print()
        sys.exit(130)
