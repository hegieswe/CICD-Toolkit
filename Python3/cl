#!/usr/bin/env python3

import sys
import shutil
import subprocess
from pathlib import Path

# =========================
# Config
# =========================
WORKSPACE = "loyaltoid"

# === Colors ===
YELLOW = "\033[33m"
GREEN = "\033[32m"
RED = "\033[31m"
BOLD = "\033[1m"
RESET = "\033[0m"

# === Icons ===
INFO_ICON = "‚ÑπÔ∏è "
WARN_ICON = "‚ö†Ô∏è "
SUCCESS_ICON = "‚úÖ "
ERROR_ICON = "‚ùå "
REPO_ICON = "üì¶ "

# =========================
# Logging
# =========================
def log_info(msg):
    print(f"{YELLOW}{INFO_ICON}{BOLD}{msg}{RESET}")

def log_repo(msg):
    print(f"{YELLOW}{REPO_ICON}{BOLD}{msg}{RESET}")

def log_danger(msg):
    print(f"{RED}{WARN_ICON}{BOLD}{msg}{RESET}")

def log_success(msg):
    print(f"{GREEN}{SUCCESS_ICON}{BOLD}{msg}{RESET}")

def log_error(msg):
    print(f"{RED}{ERROR_ICON}{BOLD}{msg}{RESET}")

def fatal(msg, code=1):
    log_error(msg)
    sys.exit(code)

# =========================
# Usage
# =========================
def usage():
    log_error("Invalid usage")
    print("Usage:")
    print("  cl <repo> <branch|tag>")
    print("  cl <repo> <branch|tag> sl   # single branch clone")
    sys.exit(1)

# =========================
# Validation
# =========================
args = sys.argv[1:]

if len(args) < 2 or len(args) > 3:
    usage()

REPO = args[0]
REF = args[1]
MODE = args[2] if len(args) == 3 else ""

REPO_URL = f"https://bitbucket.org/{WORKSPACE}/{REPO}.git"
REPO_DIR = Path(REPO)

# =========================
# Cleanup
# =========================
if REPO_DIR.exists():
    log_danger(f"Directory '{REPO}' already exists. Removing...")
    try:
        shutil.rmtree(REPO_DIR)
    except Exception as e:
        fatal(f"Gagal menghapus directory '{REPO}': {e}")

# =========================
# Info summary
# =========================
log_repo(f"Repository : {REPO}")

if MODE == "sl":
    log_info(f"Branch/Tag : {REF} (Single branch)")
else:
    log_info(f"Branch/Tag : {REF} (Full clone)")

# =========================
# Clone logic
# =========================
try:
    if MODE == "sl":
        subprocess.run(
            [
                "git", "clone",
                "--branch", REF,
                "--single-branch",
                REPO_URL
            ],
            check=True
        )
    else:
        subprocess.run(
            ["git", "clone", REPO_URL],
            check=True
        )
        subprocess.run(
            ["git", "checkout", REF],
            cwd=REPO_DIR,
            check=True
        )
except FileNotFoundError:
    fatal("Git tidak ditemukan. Pastikan git sudah terinstall.")
except subprocess.CalledProcessError:
    fatal("Git command gagal dijalankan.")

# =========================
# Done
# =========================
log_success(f"Clone completed successfully: {REPO}")