#!/usr/bin/env python3
"""
cl - Fast Git Clone Tool
Simple and fast repository cloning.

Usage:
    cl repo                  # Full clone (default branch)
    cl repo branch           # Full clone + checkout branch/tag
    cl repo branch -s        # Fast single-branch clone (recommended)
"""

import sys
import os
import shutil
import subprocess
import time
import threading
import re
from pathlib import Path

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DEFAULT_WORKSPACE = "loyaltoid"
DEFAULT_GIT_HOST = "bitbucket.org"
VERSION = "3.0.0"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STYLING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Style:
    CYAN    = "\033[96m"
    GREEN   = "\033[92m"
    YELLOW  = "\033[93m"
    RED     = "\033[91m"
    MAGENTA = "\033[95m"
    BLUE    = "\033[94m"
    BOLD    = "\033[1m"
    DIM     = "\033[2m"
    RESET   = "\033[0m"

class Icon:
    SUCCESS  = "âœ”"
    ERROR    = "âœ–"
    WARN     = "âš "
    REPO     = "ğŸ“¦"
    LINK     = "ğŸ”—"
    BRANCH   = "ğŸŒ¿"
    MODE     = "âš¡"
    ROCKET   = "ğŸš€"
    CLOCK    = "â± "
    SIZE     = "ğŸ’¾"
    SPEED    = "ğŸš€"
    RECYCLE  = "â™»ï¸ "

class Box:
    TL = "â•­"
    TR = "â•®"
    BL = "â•°"
    BR = "â•¯"
    H  = "â”€"
    V  = "â”‚"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SPINNER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Spinner:
    FRAMES = ["â ‹", "â ™", "â ¹", "â ¸", "â ¼", "â ´", "â ¦", "â §", "â ‡", "â "]
    
    def __init__(self, message="Processing..."):
        self.message = message
        self.busy = False
        self.delay = 0.08
        self._thread = None
        self._progress = ""
        self._lock = threading.Lock()
    
    def update_progress(self, progress):
        with self._lock:
            self._progress = progress
    
    def _spin(self):
        i = 0
        while self.busy:
            with self._lock:
                progress = self._progress
            line = f"\r{Style.CYAN}{self.FRAMES[i % 10]}{Style.RESET} {self.message}"
            if progress:
                line += f" {Style.DIM}{progress}{Style.RESET}"
            sys.stdout.write(f"{line:<80}")
            sys.stdout.flush()
            time.sleep(self.delay)
            i += 1
    
    def start(self):
        self.busy = True
        self._thread = threading.Thread(target=self._spin, daemon=True)
        self._thread.start()
    
    def stop(self, success=True, message=None):
        self.busy = False
        if self._thread:
            self._thread.join(timeout=0.2)
        icon = f"{Style.GREEN}{Icon.SUCCESS}" if success else f"{Style.RED}{Icon.ERROR}"
        sys.stdout.write(f"\r{icon}{Style.RESET} {message or self.message:<75}\n")
        sys.stdout.flush()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UTILITIES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def format_size(b):
    for u in ['B', 'KB', 'MB', 'GB']:
        if b < 1024:
            return f"{b:.1f} {u}"
        b /= 1024
    return f"{b:.1f} TB"

def format_time(s):
    if s < 1:
        return f"{s * 1000:.0f}ms"
    elif s < 60:
        return f"{s:.1f}s"
    return f"{int(s // 60)}m {s % 60:.0f}s"

def get_size(path):
    total = 0
    try:
        for e in os.scandir(path):
            if e.is_file(follow_symlinks=False):
                total += e.stat().st_size
            elif e.is_dir(follow_symlinks=False):
                total += get_size(e.path)
    except (PermissionError, OSError):
        pass
    return total

def fatal(msg):
    print(f"  {Style.RED}{Icon.ERROR}{Style.RESET} {Style.BOLD}{msg}{Style.RESET}")
    sys.exit(1)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GIT OPERATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def clone_with_progress(cmd, spinner):
    proc = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    output = []
    for line in iter(proc.stderr.readline, ''):
        output.append(line)
        if "Receiving objects:" in line:
            m = re.search(r'(\d+)%', line)
            if m:
                spinner.update_progress(f"Receiving: {m.group(1)}%")
        elif "Resolving deltas:" in line:
            m = re.search(r'(\d+)%', line)
            if m:
                spinner.update_progress(f"Resolving: {m.group(1)}%")
        elif "Cloning into" in line:
            spinner.update_progress("Connecting...")
    proc.wait()
    return proc.returncode, ''.join(output)

def run_clone(repo, ref, single_branch, workspace, host):
    repo_dir = Path(repo)
    repo_url = f"git@{host}:{workspace}/{repo}.git"
    replaced = False
    
    # Mode
    mode_str = f"{Style.GREEN}Single Branch{Style.RESET} (depth: 1)" if single_branch else f"{Style.BLUE}Full Clone{Style.RESET}"
    
    # Build info lines for dynamic box width
    info_lines = [
        f"{Icon.REPO} Repository:  {repo}",
        f"{Icon.LINK} Source:      {repo_url}",
    ]
    if ref:
        info_lines.append(f"{Icon.BRANCH} Ref:         {ref}")
    # Mode line (without ANSI for width calculation)
    mode_plain = "Single Branch (depth: 1)" if single_branch else "Full Clone"
    info_lines.append(f"{Icon.MODE} Mode:        {mode_plain}")
    
    # Calculate box width
    max_len = max(len(line) for line in info_lines)
    box_width = max_len + 4  # padding
    box_width = max(box_width, 40)  # minimum
    
    # Print header box
    title = "Repository Information"
    title_line = f"{Box.TL}{Box.H}{title}{Box.H * (box_width - len(title) - 1)}{Box.TR}"
    
    print()
    print(f"{Style.GREEN}{title_line}{Style.RESET}")
    print(f"{Style.GREEN}{Box.V}{Style.RESET}{Icon.REPO} {Style.RED}Repository :{Style.RESET} {Style.GREEN}{repo}{Style.RESET}")
    print(f"{Style.GREEN}{Box.V}{Style.RESET}{Icon.LINK} {Style.RED}Source     :{Style.RESET} {Style.GREEN}{repo_url}{Style.RESET}")
    if ref:
        print(f"{Style.GREEN}{Box.V}{Style.RESET}{Icon.BRANCH} {Style.RED}Ref        :{Style.RESET} {Style.GREEN}{ref}{Style.RESET}")
    print(f"{Style.GREEN}{Box.V}{Style.RESET}{Icon.MODE} {Style.RED}Mode       :{Style.RESET} {Style.GREEN}{mode_plain}{Style.RESET}")
    print(f"{Style.GREEN}{Box.BL}{Box.H * box_width}{Box.BR}{Style.RESET}")
    print()
    
    # Remove existing (auto-overwrite)
    if repo_dir.exists():
        spinner = Spinner(f"Removing existing '{repo}'...")
        spinner.start()
        try:
            shutil.rmtree(repo_dir)
            spinner.stop(success=True, message=f"Removed existing '{repo}'")
            replaced = True
        except Exception as e:
            spinner.stop(success=False)
            fatal(f"Failed to remove: {e}")
    
    # Build command
    cmd = ["git", "clone", "--progress"]
    if single_branch:
        cmd.extend(["--single-branch", "--depth", "1"])
        if ref:
            cmd.extend(["--branch", ref])
    cmd.extend([repo_url, str(repo_dir)])
    
    # Clone
    start = time.perf_counter()
    spinner = Spinner(f"Cloning {repo}...")
    spinner.start()
    
    try:
        code, stderr = clone_with_progress(cmd, spinner)
        if code != 0:
            spinner.stop(success=False, message="Clone failed")
            if stderr:
                print(f"\n{Style.DIM}{stderr}{Style.RESET}")
            fatal("Git clone failed.")
        spinner.stop(success=True, message=f"Cloned {repo}")
    except KeyboardInterrupt:
        spinner.stop(success=False, message="Cancelled")
        if repo_dir.exists():
            shutil.rmtree(repo_dir, ignore_errors=True)
        sys.exit(130)
    
    # Checkout (full clone only)
    if ref and not single_branch:
        spinner = Spinner(f"Checking out {ref}...")
        spinner.start()
        result = subprocess.run(["git", "checkout", ref], cwd=repo_dir, capture_output=True, text=True)
        if result.returncode == 0:
            spinner.stop(success=True, message=f"Checked out {ref}")
        else:
            spinner.stop(success=False, message=f"Failed to checkout {ref}")
            if result.stderr:
                print(f"  {Style.DIM}{result.stderr.strip()}{Style.RESET}")
    
    # Summary
    elapsed = time.perf_counter() - start
    size = get_size(repo_dir)
    
    print()
    print(f"  {Icon.CLOCK}  Duration  : {Style.GREEN}{format_time(elapsed)}{Style.RESET}")
    print(f"  {Icon.SIZE}  Size      : {Style.CYAN}{format_size(size)}{Style.RESET}")
    print(f"  {Icon.SPEED}  Speed     : {Style.CYAN}{format_size(size / elapsed)}/s{Style.RESET}")
    if replaced:
        print(f"  {Icon.RECYCLE}  Replaced  : {Style.YELLOW}Yes{Style.RESET}")
    print()
    print(f"  {Style.GREEN}{Icon.SUCCESS} Ready{Style.RESET} â†’ {Style.DIM}cd {repo}{Style.RESET}")
    print()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def print_usage():
    print(f"""
{Style.CYAN}{Style.BOLD}cl{Style.RESET} - Fast Git Clone Tool {Style.DIM}v{VERSION}{Style.RESET}

{Style.BOLD}Usage:{Style.RESET}
    cl <repo>                     Full clone (default branch)
    cl <repo> <branch/tag>        Full clone + checkout branch/tag  
    cl <repo> <branch/tag> -s     Fast single-branch clone {Style.GREEN}(recommended){Style.RESET}

{Style.BOLD}Options:{Style.RESET}
    -s, --single     Single-branch mode (faster clone)
    -w, --workspace  Override workspace (default: {DEFAULT_WORKSPACE})
    --host           Override git host (default: {DEFAULT_GIT_HOST})
    -h, --help       Show this help
    -v, --version    Show version

{Style.BOLD}Examples:{Style.RESET}
    cl myrepo                     Clone repo with full history
    cl myrepo main                Clone and checkout 'main' branch
    cl myrepo v1.0.0 -s           Fast clone tag 'v1.0.0' only

{Style.BOLD}Note:{Style.RESET}
    If directory exists, it will be {Style.YELLOW}automatically replaced{Style.RESET}.
""")

def main():
    args = sys.argv[1:]
    
    # Defaults
    workspace = os.environ.get("CL_WORKSPACE", DEFAULT_WORKSPACE)
    host = os.environ.get("CL_GIT_HOST", DEFAULT_GIT_HOST)
    single_branch = False
    repo = None
    ref = None
    
    # Parse args manually for simplicity
    positional = []
    i = 0
    while i < len(args):
        arg = args[i]
        if arg in ["-h", "--help"]:
            print_usage()
            sys.exit(0)
        elif arg in ["-v", "--version"]:
            print(f"cl {VERSION}")
            sys.exit(0)
        elif arg in ["-s", "--single"]:
            single_branch = True
        elif arg in ["-w", "--workspace"] and i + 1 < len(args):
            i += 1
            workspace = args[i]
        elif arg == "--host" and i + 1 < len(args):
            i += 1
            host = args[i]
        elif not arg.startswith("-"):
            positional.append(arg)
        else:
            print(f"{Style.RED}Unknown option: {arg}{Style.RESET}")
            sys.exit(1)
        i += 1
    
    if len(positional) < 1:
        print_usage()
        sys.exit(1)
    
    repo = positional[0]
    ref = positional[1] if len(positional) > 1 else None
    
    # Check git
    try:
        subprocess.run(["git", "--version"], capture_output=True, timeout=5, check=True)
    except Exception:
        fatal("Git not found. Please install git.")
    
    run_clone(repo, ref, single_branch, workspace, host)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print()
        sys.exit(130)
